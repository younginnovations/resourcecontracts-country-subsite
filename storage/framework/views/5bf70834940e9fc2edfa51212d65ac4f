<?php
use Illuminate\Support\Facades\Lang;

$url = Request::all();
$order=\Illuminate\Support\Facades\Input::get('order','');
$sortBy=\Illuminate\Support\Facades\Input::get('sortby','');
$route=Request::path();
?>

<table class="table table-responsive table-contract table-contract-list">
    <thead>
    <th></th>
    <th width="50%">
        <a href="<?php echo e(appendInUrl($route,$url,"contract_name",$order)); ?>"><?php echo app('translator')->get('global.document'); ?> <?php echo show_arrow($order, $sortBy=='contract_name'); ?></a>
    </th>
    <th></th>

    <th><a href="<?php echo e(appendInUrl($route,$url,"year",$order)); ?>"><?php echo app('translator')->get('global.year'); ?> <?php echo show_arrow($order, $sortBy=='year'); ?></a></th>
    <th width="15%"><a href="<?php echo e(appendInUrl($route,$url,"resource",$order)); ?>"><?php echo app('translator')->get('global.resource'); ?> <?php echo show_arrow($order, $sortBy=='resource'); ?></a> </th>
    <th width="15%"><a href="<?php echo e(appendInUrl($route,$url,"contract_type",$order)); ?>"><?php echo app('translator')->get('contract.contract_type'); ?> <?php echo show_arrow($order, $sortBy=='contract_type'); ?></a></th>

    </thead>
    <tbody>
    <?php $__empty_1 = true; foreach($contracts->results as $contract): $__empty_1 = false; ?>
        <?php
        $api = app('App\Http\Services\APIService');
        $annotations = $api->getAnnotations($contract->id);
        ?>
        <tr>
            <td></td>
            <td>

                <?php if(isset($show_advanc)): ?><input type="checkbox" class="compare" name="compare[]" value="<?php echo e($contract->open_contracting_id); ?>" /><?php endif; ?>
                <a class="title-<?php echo e($contract->open_contracting_id); ?>" href="<?php echo e(route('contract.detail',['id'=>$contract->open_contracting_id ])); ?>">
                    <?php echo e(isset($contract->name) ? $contract->name : ''); ?>

                </a>
                <?php if($annotations->total>0): ?>
                    <div class="annotate-text"> <?php echo app('translator')->get('global.annotated'); ?></div>
                <?php endif; ?>

                <div class="search-text">
                    <?php if(isset($contract->text ) && $contract->text !=''): ?>
                        <p><?php echo $contract->text.'...'; ?></p>
                    <?php endif; ?>

                    <?php if(isset($contract->annotations ) && $contract->annotations !=''): ?>
                        <p><?php echo $contract->annotations.'...'; ?></p>
                    <?php endif; ?>

                    <?php if(isset($contract->metadata ) && $contract->metadata !=''): ?>
                        <p><?php echo $contract->metadata.'...'; ?></p>
                    <?php endif; ?>
                </div>
                <?php if($annotations->total>0): ?>
                    <?php if(\Illuminate\Support\Facades\Input::has('annotation_category')): ?>
                        <?php $annotation_categories = \Illuminate\Support\Facades\Input::get(
                                'annotation_category'
                        )?>
                        <?php foreach($annotation_categories as $category): ?>
                            <?php
                            $annotation = searchInArray(
                                    $annotations->result,
                                    'category',
                                    $category
                            );
                            ?>
                            <?php if($annotation): ?>
                                <?php $annotation_type = isset($annotation['shapes']) ? 'pdf' : 'text'; ?>
                                <?php echo e(str_limit($category,50)); ?>-<span
                                        style="color: #404040;"><?php echo e(str_limit($annotation['text'],50)); ?></span>
                                <a style="float: none" href="<?php echo e(route('contract.detail',['id'=>$contract->open_contracting_id])); ?>#/<?php echo e($annotation_type); ?>/page/<?php echo e($annotation['page_no']); ?>/annotation/<?php echo e($annotation['id']); ?>">
                                    [Pg <?php echo e($annotation['page_no']); ?>]</a>
                                <br>
                            <?php endif; ?>
                        <?php endforeach; ?>

                    <?php endif; ?>
                <?php endif; ?>
                <?php if(isset($contract->group) && count($contract->group)>0): ?>
                    <div class="contract-group">
                        <label for=""><?php echo app('translator')->get('search.found_in'); ?>: </label>
                        <?php foreach($contract->group as $group): ?>
                            <a><?php echo e($group); ?></a>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            </td>
            <td>
                <div class="contract-info-section">
                    <div class="download-main-wrap">
                        <div class="download-wrap">

                            <span>Download</span>
                        </div>
                        <ul class="dropdown-menu">
                            <li><a href="<?php echo e(route('contract.download.pdf',['id'=> $contract->open_contracting_id])); ?>" >Pdf</a></li>
                            <?php if(env('CATEGORY')!="olc" && $contract->is_ocr_reviewed == 1): ?>
                                <li><a href="<?php echo e(route('contract.download',['id'=> $contract->open_contracting_id])); ?>" >Word File</a></li>
                            <?php endif; ?>
                        </ul>
                    </div>
                </div>
            </td>

            <?php if($contract->year_signed !=''): ?>
                <td><?php echo e($contract->year_signed); ?></td>
            <?php else: ?>
                <td></td>
            <?php endif; ?>
            <td>
                <?php

                    if (isset($url['sortby']) && $url['sortby'] == "resource") {
                        if ($url['order'] == "asc") {
                            asort($contract->resource);
                        }
                        if ($url['order'] == "desc") {
                            rsort($contract->resource);
                        }
                    }
                ?>
                <ul>
                    <?php $__empty_2 = true; foreach($contract->resource as $resource): $__empty_2 = false; ?>
                        <?php if(!empty($resource)): ?>
                            <li>
                            <?php if(Lang::has('resources.'.$resource)): ?>
                                    <?php echo app('translator')->get('resources.'.$resource); ?>
                            <?php else: ?>
                                <?php echo e($resource); ?>

                            <?php endif; ?>
                            </li>
                        <?php else: ?>
                            -
                        <?php endif; ?>
                    <?php endforeach; if ($__empty_2): ?>
                        -
                    <?php endif; ?>
                </ul>
            </td>
            <td>
             <?php if(is_array($contract->contract_type)): ?>
                    <?php foreach($contract->contract_type as $contracttype): ?>
                        <?php if(!empty($contracttype)): ?>
                            <li><?php echo e($contracttype); ?></li>
                        <?php else: ?>
                            -
                        <?php endif; ?>
                    <?php endforeach; ?>
             <?php endif; ?>
            </td>
        </tr>
    <?php endforeach; if ($__empty_1): ?>
        <tr>
            <td colspan="6" class="search-not-found"><?php echo app('translator')->get('search.search_not_found' , ['link' => route('contracts')]); ?></td>
        </tr>
    <?php endif; ?>
    </tbody>
</table>